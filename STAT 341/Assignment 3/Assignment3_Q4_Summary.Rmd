---
title: "Assignment 3 Question 4"
author: "Fenglin Chen"
date: "14/11/2021"
output: word_document
---

\newpage
## Summary

The significance level is a measure of how unusual the difference between two population attributes $\alpha(\mathcal{P}_1)$ & $\alpha(\mathcal{P}_2)$ are compared to the difference between attributes of randomly mixed sub-populations.

There are 4 main steps:
    
1. State the null hypothesis H0: $\mathcal{P}_1$ and $\mathcal{P}_2$ are drawn from the same population.
2. Formulate a discrepancy measure $D(\mathcal{P}_1, \mathcal{P}_2)$ or test statistic that quantifies how inconsistent the null hypothesis is with the observations.
3. Apply the discrepancy measure to the observed populations.
4. Apply the discrepancy measure to randomly shuffled sub-populations and calculate the proportion (p-value) of random discrepancies higher than the original.

Finally, either conclude that there is no evidence or there is sufficient evidence against H0 at some significance level.

## Mathematical Formula

The observed discrepancy (baseline) is calculated on the original populations:

$$
d_{obs} = D(\mathcal{P}_1, \mathcal{P}_2)
$$

Random sub-populations are generated by shuffling $\mathcal{P}_1$ and $\mathcal{P}_2$ $M$ times:

$$
(\mathcal{P}_{1,1}^\star,\mathcal{P}_{2,1}^\star), (\mathcal{P}_{1,2}^\star,\mathcal{P}_{2,2}^\star), \ldots, (\mathcal{P}_{1,M}^\star,\mathcal{P}_{2,M}^\star)
$$

Finally, calculate the p-value as the proportion of shuffled discrepancy values greater than the observed discrepancy:

$$
\text{p-value} = \frac{1}{M}\sum_{i=1}^{M}I\left(  D(\mathcal{P}_{1,i}^\star, \mathcal{P}_{2,i}^\star ) \ge d_{obs}\right)
$$

## General Code

```{r}
# Generate randomly shuffled sub-populations
mixRandomly <- function(pop) {
  pop1 <- pop$pop1
  n_pop1 <- nrow(pop1)
  pop2 <- pop$pop2
  n_pop2 <- nrow(pop2)
  mix <- rbind(pop1,pop2)
  select4pop1 <- sample(1:(n_pop1 + n_pop2), n_pop1, replace = FALSE)
  new_pop1 <- mix[select4pop1,]  
  new_pop2 <- mix[-select4pop1,]
  list(pop1=new_pop1, pop2=new_pop2)
}
```
```{r}
# Define the discrepancy measure
getDiscrepancy <- function(variate, attr) {
  function(pop) {attr(pop$pop1[, variate]) - attr(pop$pop2[,variate])}
}
```

## Code Example

In this example, we calculate the significance level that New York City's Gen Ed class size is different from its Collaborative Team Teaching (CTT) class size.


```{r}
boroughs <- read.csv("Borough_Summary.csv", header=TRUE)
pop <- list(pop1 = subset(boroughs, boroughs$PROGRAM.TYPE == "GEN ED"), 
            pop2 = subset(boroughs, boroughs$PROGRAM.TYPE == "CTT"))
set.seed(341)

discFn <- getDiscrepancy("AVERAGE.CLASS.SIZE", mean)
disc.random <- sapply(1:1000, FUN = function(...){ 
  discFn(mixRandomly(pop)) 
})

disc.prop <- mean( abs(disc.random) >= discFn(pop) )
disc.prop
```

Since the significance level/p-value is very high (0.29), we conclude that there is insufficient evidence against the two populations coming from the same distribution.

```{r, echo=FALSE}
# Plot the results
hist(disc.random, breaks="FD", prob=TRUE,
     main = "Randomly Mixed Populations", xlab="Difference in Class Sizes",
     col="lightgrey")
abline(v=discFn(pop), col = "red", lwd=2)
```